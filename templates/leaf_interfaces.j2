###############
# Ansible generated config, will be overwritten!
###############

###############
# General
###############
auto lo
iface lo inet loopback
   address {{ lo }}

auto eth0
iface eth0 inet dhcp
  vrf mgmt

auto mgmt
iface mgmt
  address 127.0.0.1/8
  vrf-table auto

###############
# Bridge / Vlans
###############

auto bridge
iface bridge
  bridge-vlan-aware yes
  bridge-ports {{ ports | join(" ") }} peerlink glob swp1-48
  bridge-vids {{ vlans | join(" ") }}

  {% if bridge is defined %}
  bridge-pvid {{ bridge["native"] }}
  bridge-stp on
  {% if bridge["priority"] is defined %}
  mstpctl-treeprio {{ bridge["priority"] }}
  {% endif %}
  {% endif %}

###############
# In band mgmt
###############

auto vlan{{ ib_mgmt }}
iface vlan{{ib_mgmt}}
  address 10.{{ ib_mgmt }}.0.{{ lo | regex_replace('^10.255.255.(.*)$', '\\1') }}
  vlan-id {{ ib_mgmt }}
  vlan-raw-device bridge

###############
# MLAG
###############

{% if mlag is defined %}
auto peerlink
iface peerlink
  bond-slaves {{ mlag["members"] | join(" ") }}
  mtu 9216

auto peerlink.4094
iface peerlink.4094
  address {{ mlag["address"] }}
  clagd-peer-ip {{ mlag["peer-ip"] }}
  clagd-backup-ip {{ mlag["backup-ip"] }} vrf mgmt
  clagd-sys-mac {{ mlag["sysmac"] }}
  {% if mlag["priority"] is defined %}
  clagd-priority {{ mlag["priority"] }}
  {% endif %}
{% endif %}

###############
# Client ports
###############

{% if ports is defined %}
{% for port in ports -%}

{% if ports[port]["mlag"] %}
{% for member in ports[port]["members"] -%}
auto {{ member }}
iface {{ member }}
{% endfor %}
{% endif %}

auto {{ port }}
iface {{ port }}
  {% if ports[port]["mtu"] is defined %}
  mtu {{ ports[port]["mtu"] }}
  {% else %}
  mtu 9000
  {% endif %}
  {% if ports[port]["alias"] is defined %}
  alias {{ ports[port]["alias"] }}
  {% endif %}
  {% if ports[port]["mlag"] %}
  clag-id {{ ports[port]["mlag-id"] }}
  bond-slaves {{ ports[port]["members"] | join(" ") }}
  {% else %}
  mstpctl-bpduguard yes
  mstpctl-portadminedge yes
  {% endif %}
  {% if ports[port]["trunk"] %}
  {% if ports[port]["vlans"] is defined %}
  bridge-vids {{ ports[port]["vlans"] | join(" ") }}
  {% endif %}
  {% if ports[port]["voip"] is defined %}
  bridge-pvid {{ ports[port]["voip"]["data-vlan"] }}
  bridge-vids {{ ports[port]["voip"]["voice-vlan"] }}
  {% endif %}
  {% else %}
  bridge-access {{ ports[port]["vlan"] }}
  {% endif %}

{% endfor %}

{% for port in range(1,49) %}
{% set port_name = 'swp' + port|string %}
{% if ports[port_name] is undefined %}
auto {{ port_name }}
iface {{ port_name }}
  mstpctl-bpduguard yes
  mstpctl-portadminedge yes
  bridge-access {{ bridge["native"] }}
{% endif %}
{% endfor %}

{% endif %}
